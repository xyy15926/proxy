---
title: Terminal、CLI、Shell、TTY
categories:
  - Linux
  - Kernel
tags:
  - Linux
  - Kernel
  - Driver
  - Terminal
date: 2019-07-31 21:11:41
updated: 2021-08-10 16:43:15
toc: true
mathjax: true
comments: true
description: Terminal、CLI、Shell、TTY
---

##	Terminal

###	*Terminal* 终端机

-	*Termianl* 终端：计算机领域的终端是指用于 **与计算机进行交互的输入输出设备**
	-	本身不提供运算处理功能
	-	大部分情况下
		-	终端将用户的字符以外键盘输入转为控制序列
		-	但接收到 `<C-C>` 等特殊组合键时，发送特殊信号
	-	历史上终端包含打印机、键盘、串口，*TeleType* 电传打字机可以视为这类设备的统称
		-	键盘输入指令
		-	纸带打印信号

-	*Console* 控制台：和计算机一体的特殊终端，用于管理主机，比普通终端权限更高
	-	一台主机一般只有一个控制台，但可以连接多个普通终端
		-	控制台可认为是计算机的基本设备
		-	终端是附加设备
	-	Console、Terminal 随着 PC 普及已经基本是同义词

-	*Character/Text Terminal* 字符终端：只能接受、显示文本信息的终端
	-	*Dumb Terminal*：哑终端
	-	*Intelligent Terminal*：智能终端，相较于哑终端
		-	理解转义序列
		-	定位光标、显示位置

-	*Graphical Terminal* 图形终端：可以显示图形、图像
	-	现在专门图形终端已经少见，基本被 **全功能显示器** 取代

> - [The TTY demystified](http://www.linusakesson.net/programming/tty/)
> - [解密 TTY](https://www.cnblogs.com/liqiuhao/p/9031803.html)
> - <https://www.cnblogs.com/sparkdev/p/11460821.html>
> - [Linux TTY/PTS概述](https://segmentfault.com/a/1190000009082089)

###	*tty* 设备 / 终端设备

```asciiflow
    +-----------------------------------------------+
    |                   Hardware                    |
    |                                               |
    |  +------+    +----------+    +------------+   |
    |  | UART |    | Physical |    | Terminal   |   |
+----->|      |<-->| Line     |<-->|            |   |
|   |  +------+    +----------+    +------------+   |
|   +-----------------------------------------------+
|
|   +-----------------------------------------------+
|   |                    Kernel                     |
|   |                                 +--------+    |
|   |   +--------+   +------------+   |        |    |       +----------------+
|   |   |  UART  |   |    Line    |   |  TTY   |<---------->| User process A |
+------>|        |<->|            |<->|        |    |       +----------------+
    |   | driver |   | discipline |   | driver |<---------->| User process B |
    |   +--------+   +------------+   |        |    |       +----------------+
    |                                 +--------+    |
    +-----------------------------------------------+
```

-	*UART dirver*：对接外部 *UART* 设备，管理字节的物理传输
	-	*UART*：通用异步接收器和发射器

-	*Line discipline* 行规范：支持用户的输入行为
	-	默认启用，提供
		-	编辑缓冲区
		-	基本编辑命令：退格、清除单词等
	-	高级编辑器可以将行规范设置为 *raw mode* 禁用其功能
	-	可以视为一个原始内核级 `sed`

-	*tty driver*：管理会话，处理各种终端设备
	-	根据终端型号、参数为每个终端创建 *tty* 设备
	-	处理用户和程序之间的交互
	-	*tty* 驱动是 *passive object* （类似的行规范同样是被动对象）
		-	拥有数据字段、方法，但没有执行上下文
		-	*tty* 驱动运行的唯一方式是，从别的进程上下文、内核中断处理程序中断调用

-	*tty* 设备 / 终端设备：*UART* 驱动、行规范、*tty* 驱动三元组
	-	此即通常意义上 *tty*
	-	用户可以在 `/dev` 下操作相应设备文件影响其行为
	-	用户需获取 *tty* 设备写入权限
		-	`login` 程序将用户设置为登录 *tty* 的所有者

###	*Foreground Process Group*

-	*Foreground process group*：记录前台进程组
	-	*tty* 收到终端输入之后
		-	检查当前前台进程组
		-	将输入放到进程组 *leader* 的输入缓存中
		-	相应的 *leader* 进程可通过 `read` 函数获取用户输入
	-	前台进程组向 *tty* 写数据时
		-	*tty* 将数据输出
	-	*Shell* 中执行不同命令时，前台进程组在变化
		-	由 *Shell* 负责更新给 *tty* 设备

	-	类 *UNIX* 系统中
		-	具体终端硬件设备抽象为操作系统内部 `/dev/tty*` 设备文件
		-	`/dev/tty[1-6]` 即对应 6 个虚拟控制台

###	*Terminal Emulator*

```asciiflow
                  +-----------------------------------------------------------------+
                  |                            Kernel                               |  +---------+
                  |                                              +--------+------+  |  | User    |
+--------------+  |                                              |        | tty1 |<-+->| Process |
|              |  | +----------+   +----------+                  |        +------+  |  +---------+
| +----------+ |  | | VGA      |   |          |                  |               |  |
| | Display  |<+--+>| Driver   |<->| Terminal |                  |               |  |  +---------+
| |          | |  | +----------+   | Emulator |  +------------+  |        +------+  |  | User    |
| +----------+ |  |                |          |  | Line       |  | TTY    | tty2 |<-+->| Process |
|              |  |                |          +--+ Discipline +--+ Driver +------+  |  +---------+
| +----------+ |  |                |          |  |            |  |               |  |
| | Keyboard | |  | +----------+   |          |  +------------+  |               |  |
| |          |<+--+>| Keyborad |<->|          |                  |        +------+  |  +---------+
| +----------+ |  | | Driver   |   |          |                  |        | tty3 |<-+->| User    |
|              |  | +----------+   +----------+                  +--------+------+  |  | Process |
+--------------+  |                                                                 |  +---------+
                  +-----------------------------------------------------------------+
```

-	仿真终端 / 终端模拟器：模拟传统终端行为的程序
	-	用于现代图形接口、不兼容图形接口命令行程序（如：*GNU* 工具集）之间交互
		-	捕获键盘输入
		-	将输入发送给 *CLI* 程序（*bash*）
		-	得到命令行程序输出结果
		-	调用图形接口（如：*X11*），将输出结果渲染至显示器
	-	终端模拟器运行在内核态中

-	此状态下 *tty* 设备和直连物理终端行为类似
	-	但此时行规范直连终端模拟器，不在需要 *UART* 及相应驱动
	-	终端模拟器仿真出视频终端：字符、图形字符属性帧缓冲器的复杂状态机

-	*Linux* 系统中 `/dev/tty1-6` 即为终端模拟器在文件系统的中表示
	-	程序对这些文件的读写实现对仿真终端的读写
	-	*tty[1-6]* 则是终端模拟器，只是不运行在图形界面中、由内核直接提供，也称虚拟控制台

-	*ttyS*：串口设备
	-	早期计算机上 *Serial Port* 最大用途就是连接终端设备
	-	所以会把行端口上设备同样抽象为 *tty* 设备

> - *Linux* 系统中，`<C-A-[F1-F6]>` 可以切换终端

###	*Pseudo Terminal* / *pty*

```asciiflow
+--------------------------------------------+
|                                            |
|             Kernel                         |
|                                            |  +--------+
|  +---------------+   +------------------+  |  | User   |
|  | Line          |   | tty Driver       |<-+->| Proces |
|  | Discipline    |<->| (pty slave side) |  |  +--------+
|  +-------^-------+   |                  |  |  | User   |
|          |           |                  |<-+->| Proces |
|          |           |                  |  |  +--------+
|  +-------v-------+   |                  |  |  | User   |
|  | pty           |   |                  |<-+->| Proces |
|  | (master side) |   +------------------+  |  +--------+
|  +-------^-------+                         |
|          |                                 |
+----------+---------------------------------+
           |
   +-------v-------+
   | Xterm         |
   | Process       |
   +---------------+K
```

-	*pty* 伪终端：在保持 *tty* 子系统完整下将终端模拟器移入用户空间
	-	在内核中分为两部分
		-	*ptmx*：*master side*
		-	*tty* 驱动：*pty slave side*

> - *tty* 子系统：*tty* 驱动和行规范

###	终端和进程

##	命令总结

-	终端情况
	-	`tty`：查看当前进程连接到终端
	-	`stty`：查看终端设置
	-	`toe`：查看支持的终端类型
	-	`infocmp`：比较终端区别


