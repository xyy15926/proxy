---
title: 进程寻址空间
categories:
  - Linux
  - Kernel
tags:
  - CS
  - OS
  - Linux
  - Kernel
  - Process
  - Address Space
  - Page
  - Segment
date: 2022-02-10 15:16:20
updated: 2022-03-30 19:18:44
toc: true
mathjax: true
description: 
---

##	寻址空间

-	进程（虚拟）寻址空间
	-	进程虚拟寻址空间独立，并非对应真正物理地址
	-	线性地址通过 **进程页表** 与真实物理地址进行映射
	-	若线性地址对应物理地址不在内存中，则产生缺页中断，进程陷入内核态
		-	检查线性地址合法性
		-	查找、分配物理页
		-	填充物理页内容：读取磁盘、置 0、不初始化
		-	更新进程页表（线性地址、物理地址映射）

###	*User Space*

-	*User Space* 用户空间
	-	*Text* 代码段：程序执行代码
	-	*Data* 数据段：已初始化、值不为 0 的全局变量、静态局部变量
		-	静态存储区：编译时即可确定，静态内存分配
		-	可读、可写
	-	*Block Start By Symbol* *BSS* 段：未初始化、或初值为 0 的全局变量、静态局部变量
		-	*BSS* 段未存储于 *ELF* 文件中
			-	*BSS* 段全 0，无需浪费空间存储
			-	载入时从段头获取需要分配的空间即可
		-	说明事项
			-	初值为 0 的全局变量、静态局部变量是否位于 *BSS* 段取决于编译器
			-	因为 *ELF* 文件中无此部分，需要载入器将 *BSS* 段内存空间置 0，或修改汇编代码，否则值不可预期
	-	*Heap* 段：存放进程运行时动态分配的内存段，可动态扩张、缩减
		-	堆中内容匿名，只能通过指针间接访问
		-	堆末端由 `break` 指针标识，可通过 `brk()`、`sbrk()` 系统调用调整堆
			-	容易造成内存碎片，可通过分为 #TODO
				-	*Block* 部分：大小相等的内存块组成，分配
				-	*Heap* 部分：*Block* 部分无法分配时使用
			-	需要切换内核态、用户态，代价高
	-	*MMap* 内存映射段
	-	*Stack* 栈
		-	功能
			-	存放函数内声明的非静态局部变量（即自动变量 `auto`）
			-	记录函数调用过程相关的维护信息
		-	由编译器自动分配、释放
		-	栈大小在运行时由内核动态调整
			-	程序使用栈超过最大值时，发生 *Stack Overflow*，程序收到 `Segmentation Fault`
		-	线性结构
		-	进程的每个线程有私有栈

|存储类型|作用域|生命周期|存储位置|声明方式|
|-----|-----|-----|-----|-----|-----|
|`auto`|`{}` 内|当前函数执行|栈|定义函数内|
|全局|整个程序|整个程序运行|初始化在 *Data* 段、否则在 *BSS* 段|函数外|
|`static` 全局|当前文件|整个程序运行|同上|函数外|
|`static` 局部|`{}` 内|整个程序运行|同上|函数内|
|`register`|`{}` 内|当前函数执行|运行时位于寄存器中|函数内|
|字符串常量|当前文件|整个程序运行|*Data* 段||

###	内存分配

-	内存分配
	-	静态分配内存：程序编译、链接时即确定内存
	-	动态分配内存：程序加载、载入、执行时分配、回收内存

-	动态内存分配有两种方式，对应两组系统调用
	-	`brk()`、`sbrk()`：推高数据段 `.data` 最高地址指针 `_edata`
	-	`mmap()`、`munmap()`：在进程虚拟寻址空间中段（堆、栈中间）寻找空闲虚拟内存
	-	以上均仅分配虚拟内存，在首次访问时将触发缺页中断，转由内核分配物理内存

