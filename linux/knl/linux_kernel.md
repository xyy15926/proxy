---
title: Linux 内核
categories:
  - Linux
  - Kernel
tags:
  - Linux
  - Kernel
  - Unix
  - POSIX
date: 2022-02-14 16:54:56
updated: 2022-02-21 15:22:01
toc: true
mathjax: true
description: 
---

##	操作系统基本概念

-	内核：操作系统运行所必须的核心过程
	-	与硬件部分交互：为包含在硬件平台上的所有低层可编程部件提供服务
		-	类 *Unix* 系统将物理组织低层细节对用户程序隐藏，通过内核交互
		-	依赖特殊硬件特性禁止与低层硬件交互、禁止访问任意物理地址
			-	*CPU* 至少包含两种执行模式
				-	*User Mode* 用户态、非特权模式
				-	*Kernel Mode* 内核态、特权模式
	-	为用户程序提供执行环境

> - Intel 80x86 架构 *CPU* 实际有 4 种执行状态，但标准 *Unix* 内核仅利用内核态、用户态

-	系统（内核）标准：指定 *API*，不限制内核内部设计
	-	*Portable Operation Systems based on Unix*：*IEEE* 制定
		-	*Linux* 内核
		-	*Unix* 衍生版本
		-	*Windows NT* 及其后续
	-	*Common Applications Environmnet*：*X/Open* 制定

-	Linux 内核特点
	-	*Monolithic Kernel* 宏（单块）结构内核：由逻辑上独立的几个成分构成
	-	可按需装载、卸载模块（内核的部分代码）
	-	Linux 实现自定义 *LWP* 作为基本的执行上下文，内核线程仅有限的被用于周期性执行内核函数
	-	可随意交叉执行处于特权模式的执行流
	-	支持不同存储模式的 *SMP*，包括 *NUMA*
		-	尽管通过大内核所使得内核少数代码串行执行
	-	面向对象虚拟文件系统，文件系统移植相对方便

###	用户

-	多用户系统：能并发、独立执行分别属于多个用户的若干应用程序的计算机
	-	必要特点：需要利用 *CPU* 特权模式相关硬件保护机制实现，否则用户程序可以直接访问系统电路克服限制
		-	认证机制：核是用户身份
		-	保护机制：防止错误程序妨碍、窥视其他程序运行
		-	记账机制：限制给用户分配的资源数

-	用户与组
	-	用户可用唯一数字 *UserID* 表示，通过登录口令保密用户资料
	-	用户可为用户组成员，用户组用 *User Group ID* 唯一标识
		-	方便有选择的共享资料
	-	类 *Unix* 系统均有特殊用户 *root*
		-	系统对 *root* 不使用通常的保护机制
		-	可访问任意用户文件、用户程序

###	进程

-	*Process* 进程：程序执行时实例、或程序运行程序的执行上下文
	-	传统系统中进程在地址空间执行单独指令序列
	-	现代系统允许有多个执行流（线程?）的进程，即在相同地址空间执行多个指令序列

-	*Multiprogramming*、*Multiprocessing* 多处理系统
	-	系统中 *Scheduler* 调度程序决定进程执行顺序
	-	*Nonpreemptable* 非抢占式进程：进程资源放弃 *CPU* 时，调度程序才被调用
	-	*Preemptable* 抢占式进程：系统记录周期性激活调度程序
		-	多用户系统中，进程必须为抢占式

-	类 *Unix* 系统采用 *进程-内核* 模式，每个进程自认为独占内核服务
	-	进程发出系统调用，硬件转换为内核态，进程开始执行内核过程
	-	内核过程迫使硬件返回用户态，然后进程继续执行之后指令

###	内核体系结构

-	*Micro Kernel* 微内核：同步原语、简单调度、进程间通信机制构成的函数集
	-	运行在微内核上的系统进程实现宏内核功能
		-	内存分配
		-	设备驱动
		-	系统调用处理
	-	特点
		-	内核各层是相对独立的程序，方便移植
		-	内核系统上系统进程消息传递代价较高，影响性能
		-	*RAM* 利用更充分，可调出、撤销无需执行系统进程

-	宏（单块结构）内核：所有内核层集成至整个内核程序中

-	*Linux* 宏内核通过模块扩展功能
	-	*Module* 模块：目标文件，可在运行时动态链接至内核或解除链接
		-	通常由一组函数组成，实现文件系统、驱动等其他内核上层功能
		-	模块不作为特殊进程执行，而与静态链接内核函数相同，表示进程在内核态执行#TODO?
	-	特点
		-	模块化方法
		-	平台无关
		-	节省内存
		-	无性能损失

##	*Unix* 文件系统概述

-	*Unix* 文件：以字节序列组成的信息载体 *Container*
	-	从用户角度，文件被组织为树结构的命名空间中
		-	除叶节点外，所有节点表示目录名
		-	目录节点包含其下文件、目录的所有信息
		-	树根对应目录即根目录，一般为 `/`
	-	进程使用路径名标识特定文件
		-	*Unix* 每个进程有当前工作目录，属于进程执行上下文
		-	`/` 开头表示绝对路径
		-	否则为相对路径，起点是进程当前工作目录
		-	`.`、`..` 标识工作目录、父目录
			-	根目录为当前工作目录时，中二者相同

-	硬链接、软链接
	-	*(Hard) Link* （硬）链接：目录中文件名
		-	文件可有多个链接，即对应多个文件名
		-	不可给目录创建硬链接：可能将目录树变为环形图
		-	只能在同一文件系统中文件才能创建链接
	-	*Soft Link*（*Symbolic Link*） 符号链接：包含另一文件任意路径名的短文件
		-	可以指向任意文件系统任意文件目录，甚至可以指向不存在文件

-	文件系统使用 *Inode* 索引节点标识文件
	-	*Inode* 包含文件系统处理文件所需的所有信息
		-	文件内不包含任何控制信息
	-	*Inode* 至少应该提供在 *POSIX* 标准中指定的属性
		-	文件类型
		-	文件关联硬链接数量
		-	文件长度（字节为单位）
		-	设备标识符（包含文件的设备标识符）
		-	索引节点号
		-	文件拥有者 *UID*
		-	文件用户组 *GID*
		-	时间戳
			-	索引节点状态修改时间
			-	最后访问时间
			-	最后修改时间
		-	访问权限、文件模式

###	文件属性

-	文件类型
	-	*Regular File* 普通文件
	-	目录
	-	符号链接
	-	*Character-oriented Device File* 面向字符的设备文件
	-	*Block-oriented Device File* 面向块的设备文件
	-	*Pipe* 管道、*Named Pipe*（*FIFO*）命名管道
	-	*Socket* 套接字

-	访问权限、文件模式
	-	文件 9 种访问权限
		-	文件潜在用户
			-	所有者
			-	同组用户（不包括所有者）
			-	其他用户
		-	访问权限：读、写、执行
	-	文件模式附加标记
		-	*Set User ID*：进程执行文件时，获得文件所有者 *UID*，而非保持进程拥有者 *UID*，即总视同所有者执行文件
		-	*Set Group ID*：进程执行文件时，获得文件用户组 *GID*，而非保持进程用户组 *GUID*
		-	*Sticky*：执行结束后仍保留在内存中（已过时）

###	相关系统调用

-	文件操作的系统调用
	-	文件系统可视为硬盘分区的物理组织的用户级视图
		-	用户态进程不能直接与低层硬件交互
		-	文件操作必须在内核态进行，即需要系统调用
	-	相关文件系统调用
		-	`<FD> = open(<PATH>, <FLAG>, <MODE>)`
		-	`create()`
		-	`<NREAD> = read(<FD>, <BUF>, <COUNT>)`
		-	`<NWRITE> = write(<FD>, <BUF>, <COUNT>)`
		-	`<NEWOFFSET> = lseek(<FD>, <OFFSET>, <WHENCE>)`
		-	`<RES> = close(<FD)`
		-	`<RES> = rename(<OLD_PATH>, <NEW_PATH>)`
		-	`<RES> = unlink(<PATH>)`

-	打开文件对象：包含进程与打开文件间交互相关的数据（进程只能访问打开的文件对象)
	-	文件操作相关数据结构
		-	文件打开方式标志
		-	文件指针
	-	进程可调用的内核函数指针

-	文件描述符：表示进程与打开文件间的交互
	-	同一打开文件对象可能由同一进程中多个文件描述符标识
	-	多个进程同时打开同一文件时，文件系统给每个文件分配单独的打开文件对象
		-	*Unix* 文件系统不提供 *I/O* 操作同步机制，但部分系统调用可用于实施同步

##	*Unix 内核*

-	进程/内核模式
	-	内核是进程管理者
		-	进程使用 *System Call* 系统调用请求内核服务
		-	系统调用设置一组识别进程请求的参数，然后执行与硬件相关的 *CPU* 指令完成用户态、内核态的转换
	-	进程总是处于用户态、或内核态
		-	用户态时：不能直接访问内核数据结构、程序
		-	内核态时：限制解除，*CPU* 处理内核例程
	-	*Kernel Thread* 内核线程：被赋予特殊权限的特权进程
		-	以内核态运行在内核地址空间
		-	通常不与用户交互，不需要终端设备
		-	通常在系统启动时创建，然后处于活跃状态直到系统关闭

-	激活内核例程的方式
	-	系统调用
	-	*CPU* 发出异常信号
	-	外围设备发出中断信号
		-	中断信号由内核中 *Interrupt Handler* 处理
		-	外部设备与 *CPU* 异步，故中断发生不可预知
	-	内核线程执行

-	每种 *CPU* 都为用户态、内核态之间转换提供特殊指令

###	进程实现

-	*Process Descriptior* 进程描述符：描述进程当前状态信息
	-	内核暂停进程执行时，将相关寄存器内容保存在进程描述符中
		-	*PC* 程序计数器、*SP* 栈指针
		-	通用寄存器
		-	浮点寄存器
		-	*Processor Status Word* 处理器状态字：包含 *CPU* 状态信息
		-	内存管理寄存器：跟踪进程对 *RAM* 的访问
	-	内核恢复进程执行时，用进程描述符中合适字段装载相关寄存器
	-	进程不在 *CPU* 上执行时，其正在等待事件
		-	*Unix* 内核使用多个进程描述符队列区分多种等待状态

####	可重入内核

-	*Unix* 内核均 *Reentrant* 可重入
	-	多个进程可“同时”在内核态下执行
		-	中断发生时，内核可以挂起内核态运行进程

-	*Kernel Control Path* 内核控制路径：内核处理系统调用、异常、中断所执行的指令序列
	-	下列事件发生时，*CPU* 交叉执行内核控制路径
		-	内核控制路径中指令自身执行“失败”
			-	对应内核控制路径证实请求无法立即满足，则选择新进程执行
			-	执行一个内核控制路径时，*CPU* 检测到异常（如缺页中断），则原控制路径挂起，开始执行异常处理控制路径
		-	内核控制路径执行过程中发生外部中断
			-	硬件中断
			-	支持抢占式内核内核中，更高优先级进程加入就绪队列

####	进程地址空间

-	进程有独立的私有地址空间
	-	用户态下运行时涉及其私有的栈、数据区、代码区
	-	内核态运行时，访问内核的数据区、代码，但是使用另外私有栈
		-	内核可重入，所以每个控制路径有其自身私有内核栈

-	进程在部分情况下可共享部分地址空间
	-	内核自动共享
		-	多进程共用程序指令段
	-	进程显式申请
		-	共享内存实现进程间通信
		-	`mmap()` 系统调用：块设备映射至多个进程地址空间中

####	同步、临界区

-	可重入内核实现需要同步机制
	-	避免内核控制路径交叉执行破坏内核全局变量 *consistent*
	-	*Critical Region* 临界区：同时只有一个进程能执行的一段代码
		-	可视为广义上的原子操作，保证共享数据一致性

-	内核控制路径同步解决方案
	-	非抢占式内核
		-	可解决同步问题
		-	在多处理器系统上低效
	-	禁止中断：在进入临界区前禁止所有硬件中断，离开时启用
		-	临界区较大时，可能导致较长时间内硬件活动冻结
		-	仅禁止本地 *CPU* 中断不够，还需要其他同步技术

-	*Semaphore* 信号量：与数据结构相关计数器，访问数据结构前需要检查
	-	组成
		-	整数变量
		-	等待进程链表
		-	原子方法 `up()`、`down()`
	-	运用逻辑
		-	控制路径希望访问数据结构时，执行对应信号量 `down()` 方法（初值 1）
		-	信号量非负时运行访问数据结构，否则，将进程进入信号量链表并阻塞进程
		-	其他进程执行 `up()` 方法后，运行信号量链表上进程继续执行
	-	特点
		-	若修改数据结构耗时短，则效率可能较低，进程插入链表、挂起操作耗时长

-	*Spin Lock* 自旋锁：执行紧凑的循环指令
	-	运行逻辑
		-	进程发现锁时，不停“旋转”，执行紧凑循环指令直至锁打开
	-	特点
		-	可能出现死锁，包括 *Linux* 在内的系统通过设置请求顺序避免死锁

#TODO









